<tool id="edgeR-hts" name="edgeR" version="0.0.2">
  <description> Estimates differential gene expression </description>
  <requirements>
        <requirement type="R-module">edgeR</requirement>
        <requirement type="R-module">limma</requirement>
  </requirements>
  <command interpreter="bash">
    edgeR-hts.sh -a $analysis_type.analysis -e $html_file.files_path -f $fdr -h $html_file -o $output
  	## Pairwise comparisons
  	#if $analysis_type.analysis == "pw":
   		-r $analysis_type.rowsumfilter
  		#if $analysis_type.tagwise_disp.twd == "TRUE":
   			-p $analysis_type.tagwise_disp.twd_prop
  			-u $analysis_type.tagwise_disp.twd_trend
  			-t
 		#end if
 	## GLM
  	#else if $analysis_type.analysis == "glm":
		#if $analysis_type.exp.export_norm == "true":
			-n $norm_exp
		#end if
 		-d $analysis_type.disp
		$analysis_type.cont_pw
 		#for $fct in $analysis_type.factors:
  			factor::${$fct.fact_name}::${$fct.fact}
  		#end for
  		#for $c in $analysis_type.cont_pred:
			cp::${c.cp_name}::${c.cp}
		#end for
		#for $cnt in $analysis_type.contrasts:
			"cnt::${cnt.add_cont}"
		#end for
	## LIMMA
	#else
		#if $analysis_type.exp.export_norm == "true":
			-n $norm_exp $analysis_type.exp.log
		#end if
		$analysis_type.cont_pw
  		#for $fct in $analysis_type.factors:
  			factor::${$fct.fact_name}::${$fct.fact}
  		#end for
  		#for $c in $analysis_type.cont_pred:
			cp::${c.cp_name}::${c.cp}
		#end for
		#for $cnt in $analysis_type.contrasts:
			"cnt::${cnt.add_cont}"
		#end for
	#end if
	$matrix
  </command>

  <inputs>
	<param format="gff3" name="anno_input_selected" type="data" label="Genome annotation in GFF3 file" help="A tab delimited format for storing sequence features and annotations"/>
   <repeat name="replicate_groups" title="Replicate group" min="2">
     <repeat name="replicates" title="Replicate">
      <param format="bam" name="bam_alignment" type="data" label="BAM alignment file" help="BAM alignment file. Can be generated from SAM files using the SAM Tools."/>
     </repeat>
   </repeat>
  	<conditional name="analysis_type">
		<param name="analysis" type="select" label="Type Of Analysis">
			<option value="pw">Pairwise comparisons (1 Factor Analysis)</option>
			<option value="glm" selected="true">Generalized Linear Models (Multiple Factor Analysis using GLM)</option>
			<option value="limma">Linear Models for RNA-Seq (Multiple Factor Analysis using LIMMA)</option>
		</param>
		<when value="pw">
			<param name="rowsumfilter" type="integer" value="5" label="Common Dispersion Rowsum Filter" help="Numeric scalar giving a value for the filtering out of low abundance tags in the estimation of the common dispersion. Only tags with total sum of counts above this value are used in the estimation of the common dispersion. Low abundance tags can adversely affect the estimation of the common dispersion, so this argument allows the user to select an appropriate filter threshold for the tag abundance."/>
			<conditional name="tagwise_disp">
				<param name="twd" type="select" label="Maximize the Negative Binomial Weighted Conditional Likelihood" help="Calculate and use an estimate of the dispersion parameter for each tag">
					<option value="TRUE" selected="true">True</option>
					<option value="FALSE">False</option>
				</param>
				<when value="TRUE">
					<param name="twd_trend" type="select" label="Method for allowing the prior distribution for the dispersion to be abundance-dependent">
						<option value="movingave" selected="true">Movingave</option>
						<option value="tricube">Tricube</option>
						<option value="none">None</option>
					</param>
					<param name="twd_prop" type="float" value="0.3" label="The proportion of all tags/genes to be used for the locally weighted estimation of the tagwise dispersion, allowing the dispersion estimates to vary with abundance (expression level)"/>
				</when>
			</conditional>
		</when>
		<when value="glm">
			<param name="disp" type="select" label="Select The Dispersion Estimate To Use:">
				<option value="common">Common Dispersion</option>
				<option value="trend">Trended Dispersion</option>
				<option value="tag" selected="true">Tagwise Dispersion</option>
			</param>
			<!--<repeat name="factors" title="Factor">
				<param name="fact_name" title="Factor Name" type="text" label="Name Of Factor (no spaces or commas)"/>
				<param name="fact" title="Factor" type="text" size="100" label="The Level Of Each Sample Seperated By A Colon (no spaces or commas)"/>
			</repeat> -->	
			<repeat name="cont_pred" title="Continuous Predictor">
				<param name="cp_name" title="Continuous Predictor Name" type="text" label="Name Of Continuous Predictor (no spaces or commas)"/>
				<param name="cp" title="Continuous Predictor" type="text" size="100" label="The Numerical Value For Each Sample Seperated By A Colon (no spaces or commas)"/>
			</repeat>
			<param name="cont_pw" type="boolean" truevalue="-m" falsevalue="" checked="True" label="Perform all pairwise comparisons" help="Include all pairwise comparisons in the contrast matrix."/>
			<!-- <repeat name="contrasts" title="Contrast">
				<param name="add_cont" title="Contrast" type="text" label="Enter the contrast of interest, e.g. (G1+G2)/2-G3 (no spaces or commas)"/>
			</repeat> --> 
			<conditional name="exp">	
				<param name="export_norm" type="select" label="Save Normalised DGE Matrix">
					<option value="true">Yes</option>
					<option value="false">No</option>
				</param>
			</conditional>
		</when>
		<when value="limma">
			<!-- <repeat name="factors" title="Factor">
				<param name="fact_name" title="Factor Name" type="text" label="Name Of Factor (no spaces or commas)"/>
				<param name="fact" title="Factor" type="text" size="100" label="The Level Of Each Sample Seperated By A Colon (no spaces or commas)"/>
			</repeat> -->	
			<repeat name="cont_pred" title="Continuous Predictor">
				<param name="cp_name" title="Continuous Predictor Name" type="text" label="Name Of Continuous Predictor (no spaces or commas)"/>
				<param name="cp" title="Continuous Predictor" type="text" size="100" label="The Numerical Value For Each Sample Seperated By A Colon (no spaces or commas)"/>
			</repeat>
			<param name="cont_pw" type="boolean" truevalue="-m" falsevalue="" checked="True" label="Perform all pairwise comparisons" help="Include all pairwise comparisons in the contrast matrix."/>
			<!-- <repeat name="contrasts" title="Contrast">
				<param name="add_cont" title="Contrast" type="text" label="Enter the contrast of interest, e.g. (G1+G2)/2-G3 (no spaces or commas)"/>
			</repeat> -->
			<conditional name="exp">	
				<param name="export_norm" type="select" label="Save Normalised DGE Matrix">
					<option value="true">Yes</option>
					<option value="false">No</option>
				</param>
				<when value="true">
					<param name="log" type="boolean" truevalue="-l" falsevalue="" checked="True" label="Export Normalised DGE Matrix in Log2" help="Selecting this will log base 2 transform the Normalised Digital Gene Expression Matrix."/>
				</when>
			</conditional>
		</when>
	</conditional>
	<param name="fdr" type="select" label="False discovery rate adjustment method">
		<option value="BH">Benjamini and Hochberg (1995)</option>
		<option value="holm">Holm (1979)</option>
		<option value="hochberg">Hochberg (1988)</option>
		<option value="hommel">Hommel (1988)</option>
		<option value="BY">Benjamini and Yekutieli (2001)</option>
		<option value="none">None</option>
	</param>
  </inputs>
  
  <outputs>
    <data format="txt" name="edger_out" label="${tool.name} on ${on_string}: Differential Expression"/>
    <data format="txt" name="Log_File" label="${tool.name} on ${on_string}: log"/>
  </outputs>
  	
	<help>

.. class:: infomark
    
**What it does**

Estimates differential gene expression for short read sequence count using methods appropriate for count data.
If you have paired data you may also want to consider Tophat/Cufflinks. 
Input must be raw count data for each sequence arranged in a rectangular matrix as a tabular file.
Note - no scaling - please make sure you have untransformed raw counts of reads for each sequence.
 
Performs digital differential gene expression analysis between groups (eg a treatment and control).
Biological replicates provide information about experimental variability required for reliable inference.

**Input**

Annotation file in GFF3, containing the necessary information about the transcripts that are to be quantified.
The BAM alignment files grouped into replicate groups, each containing several replicates.

**Output**

A tabular file containing relative expression levels, statistical estimates of differential expression probability and log file.

.. class:: infomark

.. class:: infomark

**Licenses**

When applying the LIMMA (Linear models for RNA-Seq) anlysis the tool also makes use of the limma_ Bioconductor package.
Recommended reference is Smyth, G. K. (2005). Limma: linear models for microarray data. In: 'Bioinformatics and Computational Biology Solutions using R and Bioconductor'. R. Gentleman, V. Carey, S. Dudoit, R. Irizarry, W. Huber (eds), Springer, New York, pages 397--420.

 .. _edgeR: http://www.bioconductor.org/packages/release/bioc/html/edgeR.html
 .. _limma: http://www.bioconductor.org/packages/release/bioc/html/limma.html


------

edgeR-hts Galaxy wrapper version 0.1 (July 2013)

	</help>
  
</tool>
